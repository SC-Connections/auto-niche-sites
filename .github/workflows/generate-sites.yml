import os
import csv
import requests
import subprocess
from jinja2 import Template

# --- Auto-install missing dependencies ---
try:
    from jinja2 import Template
except ImportError:
    subprocess.run(["pip", "install", "jinja2"], check=True)
    from jinja2 import Template

# --- Environment variables (from GitHub secrets) ---
RAPIDAPI_KEY = os.getenv("RAPIDAPI_KEY")
RAPIDAPI_HOST = os.getenv("RAPIDAPI_HOST", "amazon24.p.rapidapi.com")
ASSOC_TAG = os.getenv("AMAZON_ASSOC_TAG", "")

# --- Paths ---
TEMPLATE_PATH = "site_template/index.html"
OUTPUT_DIR = "dist"
NICHES_CSV = "niches.csv"

# --- Ensure output directory exists ---
os.makedirs(OUTPUT_DIR, exist_ok=True)

def fetch_products(niche):
    """Fetch top 10 products from the Amazon RapidAPI."""
    url = f"https://{RAPIDAPI_HOST}/api/product"
    headers = {
        "x-rapidapi-key": RAPIDAPI_KEY or "",
        "x-rapidapi-host": RAPIDAPI_HOST,
    }
    querystring = {"keyword": niche, "country": "US"}

    try:
        response = requests.get(url, headers=headers, params=querystring, timeout=10)
        response.raise_for_status()
        data = response.json()
        items = data.get("result", []) or data.get("products", [])
        return items[:10]
    except requests.exceptions.RequestException as e:
        print(f"‚ùå API fetch failed for {niche}: {e}")
        return []

def generate_page(niche, products):
    """Render an HTML page for the given niche."""
    with open(TEMPLATE_PATH, "r", encoding="utf-8") as f:
        template_content = f.read()
        template = Template(template_content)

    output_html = template.render(
        niche=niche.title().replace("-", " "),
        products=products,
        assoc_tag=ASSOC_TAG,
    )

    niche_dir = os.path.join(OUTPUT_DIR, niche)
    os.makedirs(niche_dir, exist_ok=True)

    with open(os.path.join(niche_dir, "index.html"), "w", encoding="utf-8") as f:
        f.write(output_html)

    print(f"‚úÖ Page created: dist/{niche}/index.html")

def main():
    print("‚öôÔ∏è Starting site generation...")

    if not os.path.exists(NICHES_CSV):
        print("‚ùå niches.csv not found.")
        return

    with open(NICHES_CSV, newline="", encoding="utf-8") as csvfile:
        reader = csv.reader(csvfile)
        for row in reader:
            if not row:
                continue
            niche = row[0].strip()
            if not niche:
                continue

            products = fetch_products(niche)
            generate_page(niche, products)

    print("üéâ All niche pages generated successfully.")

if __name__ == "__main__":
    main()
